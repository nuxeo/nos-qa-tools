apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: slave
    resource: pod
    usage: build
spec:
  nodeSelector:
    dedicated: jenkins-x-builder
  tolerations:
  - effect: NoSchedule
    key: dedicated
    operator: Equal
    value: jenkins-x-builder
  initContainers:
  - command: [ 'sh', '-c', 'chmod 777 /home/jenkins/agent']
    image: busybox:1.31.1
    name: home-jenkins-perms
    volumeMounts:
    - mountPath: /home/jenkins/agent
      name: workspace-volume
  containers:
  - name: maven
    securityContext:
      runAsUser: 1000
      fsGroup: 412    # Group ID of docker group on k8s nodes.
      privileged: true
    env:
    - name: MAVEN_OPTS
      value: -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
    - name: DOCKER_CONFIG
      value: /home/jenkins/.docker/
    - name: DOCKER_REGISTRY
      valueFrom:
        configMapKeyRef:
          name: jenkins-x-docker-registry
          key: docker.registry
    - name: DOCKER_REGISTRY_ORG
      valueFrom:
        configMapKeyRef:
          key: docker.org
          name: jenkins-x-docker-registry
    - name: NPM_CONFIG_REGISTRY
      value: http://nexus/repository/npm-group/
    - name: GIT_AUTHOR_EMAIL
      value: nos+jx@nuxeo.com
    - name: GIT_COMMITTER_EMAIL
      value: nos+jx@nuxeo.com
    - name: GIT_COMMITTER_NAME
      value: nuxeo-nos-jx
    - name: GIT_AUTHOR_NAME
      value: nuxeo-nos-jx
    - name: XDG_CONFIG_HOME
      value: /home/jenkins
    - name: JAVA_TOOL_OPTIONS
      value: -Dsun.zip.disableMemoryMapping=true -XX:+UseConcMarkSweepGC -XX:+CMSIncrementalMode
        -XX:MinHeapFreeRatio=10 -XX:MaxHeapFreeRatio=90 -XX:GCTimeRatio=4 -XX:AdaptiveSizePolicyWeight=90  -XX:+UnlockExperimentalVMOptions
        -XX:+UseCGroupMemoryLimitForHeap -XX:MaxRAMFraction=3
    - name: MY_NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
    - name: MY_POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: MY_POD_SERVICE_ACCOUNT
      valueFrom:
        fieldRef:
          fieldPath: spec.serviceAccountName
    - name: MY_POD_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    image: gcr.io/build-jx-prod/jxlabs-nos-master/nos-builder-java8:0.0.13
    resources:
      limits:
        cpu: "6"
        memory: 8Gi
      requests:
        cpu: "4"
        memory: 6Gi
    tty: true
    volumeMounts:
    - mountPath: /home/jenkins/.docker
      name: jenkins-docker-config
    - mountPath: /home/jenkins/.m2
      name: maven-settings
    - mountPath: /home/jenkins/.gnupg
      name: gpg-config
    - mountPath: /var/run/docker.sock
      name: docker-sock
    - mountPath: /home/jenkins/agent
      name: workspace-volume
  - name: container-build
    image: gcr.io/kaniko-project/executor:debug-v0.24.0
    command: [ "tail", "-f", "/dev/null" ]
    env:
    - name: GOOGLE_APPLICATION_CREDENTIALS
      value: /secrets/kaniko/kaniko-secret.json
    volumeMounts:
    - mountPath: /secrets
      name: kaniko-secret
    - mountPath: /kaniko/.docker
      name: kaniko-docker-config
    - mountPath: /home/jenkins/agent
      name: workspace-volume
  - name: jnlp
    image: jenkins/jnlp-slave
    securityContext:
      runAsUser: 1000
      allowPrivilegeEscalation: false
    env:
      - name: "JENKINS_TUNNEL"
        value: "jenkins-operator-slave-master:50000"
    volumeMounts:
    - mountPath: /home/jenkins/agent
      name: workspace-volume
  priority: 0
  restartPolicy: Never
  serviceAccountName: tekton-bot
  volumes:
  - name: workspace-volume
    emptyDir: {}
  - name: kaniko-secret
    secret:
      secretName: kaniko-secret
      items:
        - key: kaniko-secret
          path: kaniko/kaniko-secret.json
  - name: jenkins-docker-config
    secret:
      secretName: jenkins-docker-cfg
  - name: kaniko-docker-config
    secret:
      secretName: kaniko-docker-cfg
  - name: gpg-config
    secret:
      secretName: jenkins-release-gpg
  - name: maven-settings
    secret:
      secretName: jenkins-maven-settings
  - hostPath:
      path: /var/run/docker.sock
    name: docker-sock
